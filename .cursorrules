# Cursor AI Agent Rules for MFLUX

## üö® CRITICAL: Always Use `uv` Commands

**This project uses `uv` for Python package management and command execution.**

**ALWAYS use:**
- `uv run python` instead of `python` or `python3`
- `uv run uvicorn` instead of `uvicorn`
- `uv pip install` instead of `pip install`
- `uv run <command>` for any Python-related commands

**NEVER use bare `python`, `python3`, `pip`, `uvicorn`, etc.**


## üö® CRITICAL: Use the Native CLI Commands for Debugging

**ALWAYS use the native CLI commands: `mflux-debug-mlx` or `mflux-debug-pytorch`**

**Installation (one-time setup):**
```bash
cd /Users/filip/Desktop/mflux
uv tool install --editable .
```

**Available Debugger Commands (from pyproject.toml):**
- `mflux-debug-mlx` - MLX debugger CLI (includes `coverage` command)
- `mflux-debug-pytorch` - PyTorch debugger CLI (includes `coverage` command)
- `mflux-debug-clean` - Clean up everything in mflux_debugger/ directory
- `mflux-debug-kill-all` - Kill all running debug processes
- `mflux-debug-inspect-weights` - Inspect model weights
- `mflux-debug-prune` - Profile and prune unused files from transformers/diffusers

**Command Aliases/Shortcuts:**
- "kill all" / "killall" ‚Üí `mflux-debug-kill-all`
- "start debugger" / "start debugging" ‚Üí `mflux-debug-mlx start <script>` or `mflux-debug-pytorch start <script>`
- "clean" / "cleanup" ‚Üí `mflux-debug-clean --yes` (removes everything in mflux_debugger/)
- "coverage" ‚Üí `mflux-debug-mlx coverage <script>` or `mflux-debug-pytorch coverage <script>`
- "prune" / "pruning" ‚Üí `mflux-debug-prune prune <script>`
- "setup prune" ‚Üí `mflux-debug-prune setup`

**Learn interactively first:**
```bash
mflux-debug-mlx tutorial      # For MLX debugging
mflux-debug-pytorch tutorial  # For PyTorch debugging
mflux-debug-prune tutorial    # For pruning workflow
mflux-debug-inspect-weights tutorial  # For weight inspection
```

**Critical reminders:**
- ‚úÖ **`continue` polls automatically** - NEVER use `sleep` commands!
- ‚úÖ **CLI handles all session management** - Don't manually manage servers or use curl
- ‚úÖ **Fixed unique ports** - MLX=8000, PyTorch=8001 (can run simultaneously)

## üö® BEFORE Starting Any Debugging Session

**For basics:** Run the interactive tutorial first: `mflux-debug-mlx tutorial`

**For advanced features:** Read the full README:
üìñ **`README.md`**

Pay special attention to:
- **"Core Philosophy"** section - Interactive Debugging Over Scripts
- **"MLX Lazy Evaluation"** - Essential for MLX debugging  
- **"Model Porting Guide"** - Working backwards strategy
- **"Live Debugging Lessons Learned"** - Real-world debugging sessions

## Key Principles

1. **DO NOT write comparison/verification scripts** unless explicitly requested
2. **Use the interactive debugger** to inspect the real code instead
3. **Run the tutorial first** to learn basic commands hands-on

## üö® Advanced Debugging Patterns

### NO SLEEP COMMANDS!

**‚ùå WRONG Usage:**
```bash
# DON'T DO THIS - sleep is unnecessary!
mflux-debug-mlx continue &
sleep 30
mflux-debug-mlx status
```

**‚úÖ CORRECT Usage:**
```bash
# continue polls automatically every 2s
mflux-debug-mlx continue
# When it returns, you're at a breakpoint - inspect immediately!
```

### Parallel Debugging (Multiple Sessions)

**‚úÖ CORRECT - Sequential with automatic polling:**
```bash
# Start both sessions
mflux-debug-pytorch start script1.py
mflux-debug-mlx start script2.py

# Set breakpoints for both
mflux-debug-pytorch break /path/file.py 100
mflux-debug-mlx break /path/file.py 100

# Run one, wait for breakpoint (polls automatically)
mflux-debug-pytorch continue
# When this returns, you're at a breakpoint!

# Inspect PyTorch
mflux-debug-pytorch eval "tensor.shape"

# Run the other, wait for breakpoint
mflux-debug-mlx continue
# When this returns, you're at a breakpoint!

# Inspect MLX
mflux-debug-mlx eval "array.shape"

# Compare results
```

**‚ùå WRONG - Background jobs with sleep:**
```bash
# DON'T DO THIS!
(mflux-debug-pytorch continue > /tmp/log &) && (mflux-debug-mlx continue > /tmp/log2 &) && sleep 60
```

### Key Technical Points

1. **`continue` blocks until a breakpoint is hit** (or timeout, default 120s)
2. **Polling is AUTOMATIC** - checks status every 2 seconds
3. **Use `--max-wait` to adjust timeout** - e.g., `--max-wait 180` for slow model loading
4. **Sequential execution is fine** - one session waits, then the other
5. **Don't use `&` to background** - defeats automatic polling

## üö® Git Conventions

**CRITICAL: Commit vs Push Behavior**

1. **When asked to commit:**
   - ‚úÖ Commit locally only
   - ‚ùå **DO NOT push** unless explicitly asked to push
   - This applies to all repositories (mflux, transformers, diffusers)

2. **When asked to push:**
   - ‚úÖ **ALWAYS push to mflux repository only** (`/Users/filip/Desktop/mflux`)
   - ‚ùå **NEVER push to transformers or diffusers repositories**
   - These are external repos - we can commit locally but never push

3. **Local commits are fine:**
   - ‚úÖ Can commit locally to transformers/diffusers for pruning/restoration work
   - ‚úÖ These local commits stay on `main-pruned` branches
   - ‚ùå Never push these commits to origin

**Summary:**
- `git commit` = local only, no push
- `git push` = mflux repo only, never transformers/diffusers

## üö® Test Execution Rules

**CRITICAL: Test Name Interpretation**

1. **When user mentions a test name (e.g., `test_image_generation_fibo`):**
   - ‚úÖ **ALWAYS interpret as a SPECIFIC test function**, not the whole file
   - ‚úÖ Run only that specific test function: `uv run pytest tests/path/to/file.py::test_image_generation_fibo`
   - ‚ùå **NEVER run the whole file** unless explicitly asked

2. **Running whole test files:**
   - ‚úÖ Only run entire test file if user **explicitly asks** (e.g., "run the whole file", "run all tests in that file")
   - ‚ùå Never assume "run test X" means the whole file

3. **Test output behavior:**
   - ‚úÖ **ALWAYS run tests with full terminal output** - use `-v` or `-vv` flags for verbose output
   - ‚úÖ **NEVER redirect test output to log files** - user wants to see everything in terminal
   - ‚ùå **NEVER use** `> log.txt`, `--log-file`, or any output redirection for tests
   - ‚úÖ **ALWAYS set environment variable** to preserve output before running tests
   - ‚úÖ Use: `MFLUX_PRESERVE_TEST_OUTPUT=1 uv run pytest tests/path/to/file.py::test_name -v -s` (or `-vv` for even more detail)

**Examples:**
- User says: "run test_image_generation_fibo"
  - ‚úÖ Correct: `MFLUX_PRESERVE_TEST_OUTPUT=1 uv run pytest tests/image_generation/test_generate_image_fibo.py::TestImageGeneratorFibo::test_image_generation_fibo -v -s`
  - ‚ùå Wrong: `uv run pytest tests/image_generation/test_generate_image_fibo.py` (runs whole file)
  - ‚ùå Wrong: `uv run pytest tests/image_generation/test_generate_image_fibo.py::test_image_generation_fibo > log.txt` (redirects output)

- User says: "run all tests in test_generate_image_fibo.py"
  - ‚úÖ Correct: `MFLUX_PRESERVE_TEST_OUTPUT=1 uv run pytest tests/image_generation/test_generate_image_fibo.py -v -s` (explicit request for whole file)

**CRITICAL: Always use environment variable and `-s` flag:**
- ‚úÖ **ALWAYS set `MFLUX_PRESERVE_TEST_OUTPUT=1`** before running pytest
- ‚úÖ **ALWAYS use `-s` flag** with pytest to preserve output (disables output capturing)
- ‚úÖ Use: `MFLUX_PRESERVE_TEST_OUTPUT=1 uv run pytest tests/path/to/file.py::test_name -v -s`
- ‚ùå **NEVER run tests without `MFLUX_PRESERVE_TEST_OUTPUT=1` and `-s`** - user wants to see all output in real-time

---

**Run `mflux-debug-mlx tutorial` to learn interactively, then see README for advanced features.**
